<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Docs 管理后台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <i class="fas fa-book-medical text-blue-600 text-2xl mr-3"></i>
                    <span class="text-xl font-bold text-gray-900">Gemini Docs 管理后台</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showUploadModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">
                        <i class="fas fa-plus mr-2"></i> 添加文档
                    </button>
                    <button onclick="logout()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-sign-out-alt text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
        <!-- 统计卡片 -->
        <div class="mb-8 grid grid-cols-1 gap-5 sm:grid-cols-3">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-gray-500 truncate">当前文档总数</dt>
                    <dd id="total-docs" class="mt-1 text-3xl font-semibold text-gray-900">0</dd>
                </div>
            </div>
        </div>

        <!-- 文档列表 -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-4 py-5 border-b border-gray-200 sm:px-6 flex justify-between items-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">已存储文档</h3>
                <button onclick="loadDocs()" class="text-blue-600 hover:text-blue-500 text-sm font-medium">
                    <i class="fas fa-sync-alt mr-1"></i> 刷新列表
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID / 路径</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">更新时间</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="docs-list" class="bg-white divide-y divide-gray-200">
                        <!-- 加载中状态 -->
                        <tr>
                            <td colspan="4" class="px-6 py-10 text-center text-gray-500">正在加载文档列表...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 上传弹窗 -->
    <div id="upload-modal" class="fixed z-10 inset-0 hidden overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form id="upload-form">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">上传新文档</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">文件</label>
                                        <input type="file" id="file" name="file" required onchange="handleFileChange(this)"
                                            class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">文档 ID (路径)</label>
                                        <input type="text" id="doc_id" name="doc_id" placeholder="例如: category/filename.txt" required
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm border p-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">显示名称</label>
                                        <input type="text" id="name" name="name" placeholder="显示在列表中的名称" required
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm border p-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">描述 (可选)</label>
                                        <textarea id="description" name="description" rows="2"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm border p-2"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">开始上传</button>
                        <button type="button" onclick="hideUploadModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 登录弹窗 -->
    <div id="auth-modal" class="fixed z-20 inset-0 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 opacity-75"></div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-sm sm:w-full p-6 relative z-30">
                <div class="text-center mb-4">
                    <i class="fas fa-lock text-gray-400 text-3xl mb-2"></i>
                    <h3 class="text-lg font-medium text-gray-900">管理员验证</h3>
                    <p class="text-sm text-gray-500">请输入 ADMIN_PASSWORD 以继续</p>
                </div>
                <input type="password" id="admin-pw" placeholder="管理员密码" class="w-full border p-2 rounded mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="saveAuth()" class="w-full bg-blue-600 text-white py-2 rounded font-medium hover:bg-blue-700">进入管理后台</button>
            </div>
        </div>
    </div>

    <script>
        let adminPassword = localStorage.getItem('admin_password');

        function checkAuth() {
            if (!adminPassword) {
                document.getElementById('auth-modal').classList.remove('hidden');
                return false;
            }
            return true;
        }

        function saveAuth() {
            const pw = document.getElementById('admin-pw').value;
            if (pw) {
                adminPassword = pw;
                localStorage.setItem('admin_password', pw);
                document.getElementById('auth-modal').classList.add('hidden');
                loadDocs();
            }
        }

        function logout() {
            localStorage.removeItem('admin_password');
            location.reload();
        }

        async function loadDocs() {
            if (!checkAuth()) return;
            
            try {
                const res = await fetch('/api/docs', {
                    headers: { 'X-Admin-Password': adminPassword }
                });
                if (res.status === 401) {
                    logout();
                    return;
                }
                const data = await res.json();
                renderDocs(data.docs);
                document.getElementById('total-docs').textContent = data.docs.length;
            } catch (err) {
                alert('加载失败: ' + err.message);
            }
        }

        function renderDocs(docs) {
            const container = document.getElementById('docs-list');
            if (docs.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="px-6 py-10 text-center text-gray-500">暂无文档</td></tr>';
                return;
            }

            container.innerHTML = docs.map(doc => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${doc.name}</div>
                        <div class="text-xs text-gray-500">${doc.description || '无描述'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500">${doc.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(doc.updated_at).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteDoc('${doc.id}')" class="text-red-600 hover:text-red-900 p-2">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteDoc(docId) {
            if (!confirm(`确定要永久删除文档 "${docId}" 吗？此操作不可撤销且将同步删除硬盘文件。`)) return;

            try {
                const res = await fetch(`/api/docs/${encodeURIComponent(docId)}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Password': adminPassword }
                });
                if (res.ok) {
                    loadDocs();
                } else {
                    const err = await res.json();
                    alert('删除失败: ' + (err.detail || '未知错误'));
                }
            } catch (err) {
                alert('网络错误: ' + err.message);
            }
        }

        function handleFileChange(input) {
            const file = input.files[0];
            if (file) {
                const name = file.name;
                document.getElementById('name').value = name.replace(/\.[^/.]+$/, "");
                document.getElementById('doc_id').value = name;
            }
        }

        function showUploadModal() {
            document.getElementById('upload-modal').classList.remove('hidden');
        }

        function hideUploadModal() {
            document.getElementById('upload-modal').classList.add('hidden');
        }

        document.getElementById('upload-form').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'X-Admin-Password': adminPassword },
                    body: formData
                });
                if (res.ok) {
                    hideUploadModal();
                    e.target.reset();
                    loadDocs();
                } else {
                    const err = await res.json();
                    alert('上传失败: ' + (err.detail || '未知错误'));
                }
            } catch (err) {
                alert('网络错误: ' + err.message);
            }
        };

        // 初始加载
        if (adminPassword) loadDocs();
        else document.getElementById('auth-modal').classList.remove('hidden');
    </script>
</body>
</html>
